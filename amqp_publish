import time
import sqlite3
import pika
import os
import psutil

def create_table(cursor):
    cursor.execute('''CREATE TABLE IF NOT EXISTS send_data (
                        time TIMESTAMP DEFAULT (STRFTIME('%Y-%m-%d %H:%M:%f', 'NOW')),
                        size INTEGER,
                        cpu_usage FLOAT
                    )''')

def insert_data(cursor, size, process_id):
    cpu_usage = psutil.Process(process_id).cpu_percent(interval=None)
    cursor.execute("INSERT INTO send_data (size, cpu_usage) VALUES (?, ?)", (size, cpu_usage))

def publish(channel):
    process_id = os.getpid()
    print("Process ID:", process_id)
    try:
        conn = sqlite3.connect('amqpp.db')
        cursor = conn.cursor()

        create_table(cursor)

        msg_count = 1
        while True:
            time.sleep(1)
            msg = f"{msg_count}"
            size = len(msg)

            channel.basic_publish(exchange='', routing_key='hello', body=msg)

            print(f"Sending {size} to queue `hello`")
            insert_data(cursor, size, process_id)
            msg_count *= 10000000
    except KeyboardInterrupt:
        print("Publishing stopped by user")
    finally:
        conn.commit()
        conn.close()

def run():
    credentials = pika.PlainCredentials('qwerty', 'qwerty')

    connection = pika.BlockingConnection(pika.ConnectionParameters(host='broker.local', credentials=credentials))
    channel = connection.channel()
    channel.queue_declare(queue='hello')

    publish(channel)
    connection.close()

if __name__ == '__main__':
    run()
