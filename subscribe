import paho.mqtt.client as mqtt
import sqlite3
import sys
import psutil

broker = '192.168.1.7'
port = 1883
username = 'qwerty'
password = '12qwerty21'

# Get the current process ID
process_id = psutil.Process().pid

def on_connect(client, userdata, flags, rc):
    print("Connected with result code " + str(rc))
    client.subscribe("testTopic")

def on_message(client, userdata, msg):
    payload_str = msg.payload.decode()  # Convert the payload from bytes to string
    print(payload_str)  # Print the payload as a string

    # Get the size of the received message
    size = len(payload_str)

    # Get resource usage of the MQTT process
    process = psutil.Process(process_id)
    cpu_percent = process.cpu_percent()
    memory_percent = process.memory_percent()

    # Convert the size to a string
    size_str = str(size)

    # Connect to the SQLite database
    global cursor
    with sqlite3.connect('data.db') as conn:
        cursor = conn.cursor()

    # Create the table if it doesn't exist
    create_table(cursor)

    insert_data(size_str, payload_str, cpu_percent, memory_percent)  # Insert data into the database
    # Commit and close the database connection
    conn.commit()
    conn.close()

def run_mqtt_client():
    client = mqtt.Client()
    client.username_pw_set(username, password)

    client.on_connect = on_connect
    client.on_message = on_message

    client.connect(broker, port, 60)

    # Start the MQTT loop (this will keep the client running and processing messages)
    try:
        client.loop_forever()
    except KeyboardInterrupt:
        print("Exiting...")
        client.disconnect()
        sys.exit(0)

def create_table(cursor):
    cursor.execute('''CREATE TABLE IF NOT EXISTS rece (
                        time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        size INTEGER,
                        msg TEXT,
                        cpu_percent REAL,
                        memory_percent REAL
                    )''')

def insert_data(size, payload_str, cpu_percent, memory_percent):
    cursor.execute("INSERT INTO rece (size, msg, cpu_percent, memory_percent) VALUES (?, ?, ?, ?)",
                   (size, payload_str, cpu_percent, memory_percent))

if __name__ == '__main__':

    run_mqtt_client()
